<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAGI ARCHIVE | TACTICAL READER</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Space+Grotesk:wght@300;500;700;900&family=Noto+Sans+JP:wght@400;700;900&family=Noto+Serif+SC:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = { darkMode: 'class', theme: { extend: {} } }
    </script>

    <style>
        /* --- 0. 全局硬重置 (Global Hard Reset) --- */
        * { box-sizing: border-box; } /* 核心：防止padding撑爆宽度 */
        body { margin: 0; padding: 0; width: 100vw; overflow-x: hidden; }

        /* --- 1. 核心变量 --- */
        :root {
            --primary-color: #b15dff; --secondary-color: #39ff14; --bg-color: #0f0518;
            --text-main: #c0c0c0; --text-muted: #666;
            --glass-bg: rgba(10, 10, 12, 0.75); --glass-border: rgba(255, 255, 255, 0.08);
            --widget-bg: rgba(0, 0, 0, 0.4);
            --code-bg: #0b0b0b; --hud-opacity: 0.5;
            --nav-height: 4rem;
        }
        [data-mode="light"] {
            --bg-color: #f2f2f5; --text-main: #1a1a1a; --text-muted: #888;
            --glass-bg: rgba(255, 255, 255, 0.9); --glass-border: rgba(0, 0, 0, 0.05);
            --widget-bg: rgba(255, 255, 255, 0.6);
            --code-bg: #1e1e1e; --hud-opacity: 0.8;
        }

        body { 
            background-color: var(--bg-color); color: var(--text-main); font-family: 'Space Grotesk', 'Noto Sans SC', sans-serif;
            background-image: radial-gradient(circle at 50% 0%, rgba(var(--secondary-color), 0.05) 0%, transparent 60%), linear-gradient(var(--glass-border) 1px, transparent 1px), linear-gradient(90deg, var(--glass-border) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px; background-attachment: fixed;
            transition: background-color 0.5s ease, color 0.3s ease;
        }

        /* --- 2. 导航栏 (原生 Flex) --- */
        .tactical-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(var(--bg-color), 0.9); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 1.5rem;
        }
        .nav-link {
            display: flex; align-items: center; gap: 0.5rem;
            color: var(--text-muted); text-decoration: none;
            font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; font-weight: bold;
            cursor: pointer;
        }
        .nav-link:hover { color: var(--secondary-color); }
        
        /* 强制图标尺寸，防止挤压 */
        svg.lucide { width: 16px; height: 16px; min-width: 16px; flex-shrink: 0; display: block; }

        /* --- 3. 栅格布局 (Grid System) --- */
        .tactical-grid {
            display: grid;
            grid-template-columns: 1fr; /* 移动端默认 */
            gap: 2rem;
            max-width: 1400px;
            width: 100%; /* 强制占满 */
            margin: 0 auto;
            position: relative;
            padding: calc(var(--nav-height) + 2rem) 1rem 5rem 1rem;
        }
        @media (min-width: 1280px) {
            .tactical-grid {
                /* 左右定宽，中间自适应 */
                grid-template-columns: 280px minmax(0, 1fr) 280px;
                align-items: start;
            }
            .sidebar-left { position: sticky; top: 6rem; height: calc(100vh - 8rem); overflow-y: auto; }
            .sidebar-right { position: sticky; top: 6rem; height: calc(100vh - 8rem); }
        }
        @media (max-width: 1279px) {
            .sidebar-left, .sidebar-right { display: none; }
        }

        /* --- 4. 组件样式 --- */
        .widget-card {
            background: var(--widget-bg);
            border: 1px solid var(--glass-border);
            border-left: 2px solid var(--glass-border);
            padding: 1.25rem; margin-bottom: 1.5rem;
            transition: all 0.3s;
        }
        .widget-card:hover { border-left-color: var(--secondary-color); border-color: rgba(var(--secondary-color), 0.3); box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        .widget-header {
            font-family: 'JetBrains Mono'; font-size: 10px; color: var(--secondary-color);
            margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px dashed var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* 主内容面板 */
        .glass-panel { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
            position: relative; 
            padding: 2rem; 
            min-height: 60vh;
            width: 100%; /* 核心：防止被压缩 */
        }
        @media(min-width: 768px) { .glass-panel { padding: 4rem; } }

        /* HUD 角标 */
        .hud-corner { position: absolute; width: 10px; height: 10px; border: 2px solid var(--secondary-color); opacity: var(--hud-opacity); pointer-events: none; }
        .hc-tl { top: -1px; left: -1px; border-right: 0; border-bottom: 0; }
        .hc-tr { top: -1px; right: -1px; border-left: 0; border-bottom: 0; }
        .hc-bl { bottom: -1px; left: -1px; border-right: 0; border-top: 0; }
        .hc-br { bottom: -1px; right: -1px; border-left: 0; border-top: 0; }

        /* --- 5. 文章排版 (Prose) --- */
        .prose-eva h1 { font-family: 'Noto Serif SC', serif; font-size: 2.5rem; margin: 0 0 1.5rem 0; line-height: 1.2; text-align: center; }
        .prose-eva h2 { font-family: 'Noto Serif SC', serif; font-size: 1.8rem; color: var(--secondary-color); border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem; margin-top: 2.5em; }
        .prose-eva p { margin-bottom: 1.5em; line-height: 1.8; font-size: 1.05rem; text-align: justify; }
        
        /* 图片强制样式 */
        .prose-eva img { 
            max-width: 100%; height: auto; display: block; margin: 2rem auto; 
            border: 1px solid var(--glass-border); border-radius: 2px; 
            opacity: 1 !important; visibility: visible !important;
        }
        
        .prose-eva pre { background: var(--code-bg); padding: 1rem; border-radius: 4px; overflow-x: auto; margin: 2em 0; border: 1px solid var(--glass-border); }
        .prose-eva blockquote { border-left: 3px solid var(--secondary-color); background: rgba(var(--secondary-color), 0.05); padding: 1rem 1.5rem; font-style: italic; color: var(--text-muted); margin: 2em 0; }

        /* 其他组件 */
        .ops-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .ops-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            color: var(--text-muted); font-family: 'JetBrains Mono'; font-size: 10px;
            padding: 0.5rem; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .ops-btn:hover { background: var(--secondary-color); color: #000; border-color: var(--secondary-color); }

        /* Loading */
        .loading-wrap { display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-family: 'JetBrains Mono'; font-size: 12px; color: var(--secondary-color); padding: 2rem; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <script>
        (function() {
            const mode = localStorage.getItem('visualMode') || 'dark';
            if(mode === 'light') document.documentElement.setAttribute('data-mode', 'light');
            const theme = localStorage.getItem('theme') || 'default';
            if(theme !== 'default') document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 4px; z-index: 200; background: rgba(0,0,0,0.1);">
        <div id="scroll-progress" style="height: 100%; width: 0; background: var(--secondary-color); box-shadow: 0 0 10px var(--secondary-color); transition: width 0.1s;"></div>
    </div>

    <div id="lightbox" style="position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s;" onclick="Lightbox.close()">
        <img id="lightbox-img" src="" style="max-width: 90vw; max-height: 90vh; border: 1px solid var(--secondary-color); box-shadow: 0 0 30px var(--secondary-color);" onclick="event.stopPropagation()">
    </div>

    <nav class="tactical-nav">
        <a href="index.html" class="nav-link">
            <i data-lucide="arrow-left"></i>
            <span style="letter-spacing: 0.1em;">ABORT</span>
        </a>
        <div style="font-family: 'JetBrains Mono'; font-size: 10px; color: var(--text-muted); display: flex; gap: 0.5rem;">
            <span>MAGI_ARCHIVE:</span>
            <span id="stream-status" style="color: var(--secondary-color);">CONNECTING</span>
        </div>
        <button onclick="changeFontSize(1)" class="nav-link md:hidden" style="background: none; border: none;">A+</button>
    </nav>

    <div class="tactical-grid">
        
        <aside class="sidebar-left">
            <div class="widget-card">
                <div class="hud-corner hc-tl"></div><div class="hud-corner hc-tr"></div>
                <div class="widget-header">
                    <span>PILOT_DATA</span>
                    <i data-lucide="user"></i>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; background: #000; border: 1px solid var(--secondary-color); display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono'; font-size: 8px; color: var(--secondary-color); text-align: center; box-shadow: 0 0 5px rgba(var(--secondary-color),0.3); flex-shrink: 0;">SOUND<br>ONLY</div>
                    <div style="font-family: 'JetBrains Mono'; font-size: 12px; color: var(--text-muted);">
                        <div>ID: <span style="color: var(--secondary-color);">Wh1te</span></div>
                        <div>RANK: <span style="color: var(--primary-color);">CAPTAIN</span></div>
                        <div style="font-size: 10px; opacity: 0.7;">STATUS: ONLINE</div>
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; font-family: 'JetBrains Mono'; font-size: 9px; color: var(--text-muted); margin-bottom: 4px;">
                        <span>SYNC_RATIO</span>
                        <span style="color: var(--secondary-color);">400%</span>
                    </div>
                    <div style="height: 4px; background: rgba(255,255,255,0.1);"><div style="height: 100%; width: 85%; background: var(--secondary-color);"></div></div>
                </div>
            </div>

            <div class="widget-card">
                <div class="hud-corner hc-bl"></div><div class="hud-corner hc-br"></div>
                <div class="widget-header">
                    <span>OPS_CONTROLS</span>
                    <i data-lucide="settings-2"></i>
                </div>
                <div class="ops-grid">
                    <div class="ops-btn" onclick="OpsControl.toggleTheme()"><i data-lucide="sun-moon"></i> MODE</div>
                    <div class="ops-btn" onclick="window.scrollTo({top:0, behavior:'smooth'})"><i data-lucide="arrow-up-to-line"></i> TOP</div>
                    <div class="ops-btn" onclick="changeFontSize(-1)">A-</div>
                    <div class="ops-btn" onclick="changeFontSize(1)">A+</div>
                    <div class="ops-btn" style="grid-column: span 2; color: #ff5555; border-color: rgba(255,0,0,0.3);" onclick="window.location.href='index.html'">
                        <i data-lucide="log-out"></i> EJECT
                    </div>
                </div>
            </div>

            <div class="widget-card">
                <div class="widget-header">
                    <span>INDEX_STRUCTURE</span>
                    <i data-lucide="list-tree"></i>
                </div>
                <div id="toc-container" style="max-height: 300px; overflow-y: auto; font-family: 'JetBrains Mono'; font-size: 12px; color: var(--text-muted);">
                    <div style="text-align: center; opacity: 0.5; padding: 1rem;">SCANNING...</div>
                </div>
            </div>
        </aside>

        <main id="infinite-wrapper">
            <div id="initial-loader" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50vh;">
                <div style="font-family: 'JetBrains Mono'; font-size: 1.2rem; color: var(--secondary-color); margin-bottom: 1rem; letter-spacing: 0.2em;">DECRYPTING...</div>
                <div style="width: 200px; height: 2px; background: rgba(255,255,255,0.1); overflow: hidden;"><div style="width: 30%; height: 100%; background: var(--secondary-color); animation: scan 2s linear infinite;"></div></div>
            </div>
        </main>

        <aside class="sidebar-right">
            <div class="widget-card" style="height: 100%; border-style: dashed; border-color: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center;">
                 <div style="font-family: 'JetBrains Mono'; font-size: 10px; color: #555; transform: rotate(-90deg); letter-spacing: 0.2em;">RIGHT_WING_RESERVED</div>
             </div>
        </aside>

    </div>

    <div id="loading-more" class="hidden loading-wrap">
        <i data-lucide="loader-2" class="spin"></i> FETCHING NEXT ARCHIVE...
    </div>
    <div id="end-of-line" class="hidden" style="padding: 3rem; text-align: center; opacity: 0.5; font-family: 'JetBrains Mono'; font-size: 10px; letter-spacing: 0.5em; color: #555;">
        /// END OF ALL RECORDS ///
    </div>

    <script>
        lucide.createIcons();

        /* --- 0. 战术控制台逻辑 --- */
        const OpsControl = {
            toggleTheme() {
                const isLight = document.documentElement.getAttribute('data-mode') === 'light';
                if (isLight) {
                    document.documentElement.removeAttribute('data-mode');
                    localStorage.setItem('visualMode', 'dark');
                } else {
                    document.documentElement.setAttribute('data-mode', 'light');
                    localStorage.setItem('visualMode', 'light');
                }
            }
        };

        /* --- 1. 灯箱系统 --- */
        const Lightbox = {
            open(src) {
                const box = document.getElementById('lightbox');
                const img = document.getElementById('lightbox-img');
                img.src = src;
                box.style.opacity = '1'; box.style.pointerEvents = 'auto';
            },
            close() { 
                const box = document.getElementById('lightbox');
                box.style.opacity = '0'; box.style.pointerEvents = 'none';
            }
        };

        /* --- 2. 战术图像处理器 (HTTP -> HTTPS 代理) --- */
        const TacticalImager = {
            processUrl(url) {
                if (!url || typeof url !== 'string') return ''; 
                if (url.includes('images.weserv.nl')) return url;
                if (url.startsWith('http://') || url.includes('infinityfreeapp.com')) {
                    let cleanUrl = url.replace(/^https?:\/\//i, '');
                    return `https://images.weserv.nl/?url=${encodeURIComponent(cleanUrl)}&output=webp&q=85&we`;
                }
                return url;
            },
            sanitizeHtmlString(htmlString) {
                if (!htmlString) return '';
                let safeHtml = htmlString;
                // 1. 删除所有 srcset
                safeHtml = safeHtml.replace(/srcset=["'][^"']*["']/gi, ''); 
                // 2. 替换 HTTP src
                safeHtml = safeHtml.replace(/src=["'](http:\/\/[^"']+|https:\/\/[^"']*infinityfreeapp[^"']*)["']/gi, (match, url) => {
                    return `src="${this.processUrl(url)}"`;
                });
                return safeHtml;
            }
        };

        /* --- 3. 评论系统 (原生样式版) --- */
        const CommentManager = {
            apiBase: 'https://eva-proxy.whte97284.workers.dev/blog/comments',
            
            toggleComms(btn, postId) {
                const container = document.getElementById(`comms-${postId}`);
                const textSpan = btn.querySelector('span');
                const chevron = btn.querySelector('.comm-chevron');
                if (container.style.display === 'none') {
                    container.style.display = 'block';
                    textSpan.innerText = `CLOSE_COMMS_CHANNEL [ ID: ${postId} ]`;
                    chevron.style.transform = 'rotate(180deg)';
                    this.loadComments(postId);
                } else {
                    container.style.display = 'none';
                    textSpan.innerText = `OPEN_COMMS_CHANNEL [ ID: ${postId} ]`;
                    chevron.style.transform = 'rotate(0deg)';
                }
            },

            async loadComments(postId) {
                const container = document.getElementById(`comms-${postId}`);
                const url = `${this.apiBase}?post=${postId}&per_page=20`;
                const proxies = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='];
                
                container.innerHTML = `<div style="text-align:center; padding:1rem; font-family:'JetBrains Mono'; font-size:12px; color:var(--secondary-color);">SEARCHING FREQUENCIES...</div>`;

                try {
                    const res = await fetch(url);
                    if(res.ok) {
                        const data = await res.json();
                        this.renderForm(container, postId);
                        this.renderList(container, data);
                        return; 
                    }
                } catch(e) { console.log("Direct link failed, trying proxies..."); }

                let success = false;
                for (const proxy of proxies) {
                    try {
                        const res = await fetch(proxy + encodeURIComponent(url));
                        const text = await res.text();
                        if (text.trim().startsWith('<')) throw new Error("Blocked");
                        const data = JSON.parse(text);
                        this.renderForm(container, postId);
                        this.renderList(container, data);
                        success = true; break;
                    } catch (e) {}
                }
                if (!success) container.innerHTML = `<div style="color:#ff5555; text-align:center; font-family:'JetBrains Mono'; font-size:12px;">CONNECTION FAILED</div>`;
            },

            renderForm(container, postId) {
                container.innerHTML = `
                    <div style="background:rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.05); padding:1rem; margin-bottom:1rem;">
                        <div style="font-family:'JetBrains Mono'; font-size:10px; color:var(--secondary-color); margin-bottom:0.5rem;">/// TRANSMIT_DATA</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; margin-bottom:0.5rem;">
                            <input type="text" id="c-name-${postId}" placeholder="CODENAME" style="background:rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.1); color:var(--text-main); padding:0.5rem; font-family:'JetBrains Mono'; width:100%;">
                            <input type="email" id="c-email-${postId}" placeholder="SIGNAL_ID" style="background:rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.1); color:var(--text-main); padding:0.5rem; font-family:'JetBrains Mono'; width:100%;">
                        </div>
                        <textarea id="c-msg-${postId}" placeholder="MESSAGE..." style="background:rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.1); color:var(--text-main); padding:0.5rem; font-family:'JetBrains Mono'; width:100%; height:80px; margin-bottom:0.5rem;"></textarea>
                        <button onclick="CommentManager.postComment(${postId})" style="width:100%; background:rgba(var(--secondary-color),0.1); border:1px solid var(--secondary-color); color:var(--secondary-color); padding:0.5rem; cursor:pointer; font-family:'JetBrains Mono'; font-weight:bold;">SEND TRANSMISSION</button>
                        <div id="c-status-${postId}" style="display:none; margin-top:0.5rem; font-family:'JetBrains Mono'; font-size:10px; color:#999;"></div>
                    </div><div style="display:flex; flex-direction:column; gap:1rem;"></div>`;
            },

            renderList(container, comments) {
                const listEl = container.lastElementChild;
                if (!comments || comments.length === 0) {
                    listEl.innerHTML = `<div style="text-align:center; opacity:0.3; font-family:'JetBrains Mono'; font-size:12px;">NO SIGNALS DETECTED.</div>`;
                    return;
                }
                listEl.innerHTML = comments.map(c => {
                    let avatarUrl = c.author_avatar_urls ? c.author_avatar_urls['48'] : null;
                    if(avatarUrl) avatarUrl = TacticalImager.processUrl(avatarUrl);
                    const avatarHTML = avatarUrl ? 
                        `<img src="${avatarUrl}" style="width:32px; height:32px; border-radius:50%; border:1px solid rgba(255,255,255,0.1); flex-shrink:0;">` : 
                        `<div style="width:32px; height:32px; background:#000; border:1px solid var(--secondary-color); display:flex; align-items:center; justify-content:center; font-size:6px; color:var(--secondary-color); text-align:center; flex-shrink:0;">SOUND<br>ONLY</div>`;
                    
                    return `
                    <div style="border-left:2px solid rgba(255,255,255,0.1); padding-left:1rem; transition:all 0.3s;">
                        <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; font-family:'JetBrains Mono'; font-size:12px; color:var(--text-muted);">
                            ${avatarHTML}
                            <div>
                                <span style="color:var(--secondary-color); font-weight:bold;">${c.author_name}</span>
                                <span style="opacity:0.5; margin:0 0.5rem;">|</span>
                                <span>${new Date(c.date).toISOString().substring(0,16).replace('T',' ')}</span>
                            </div>
                        </div>
                        <div class="prose-eva" style="font-size:14px; line-height:1.6;">${c.content.rendered}</div>
                    </div>`;
                }).join('');
            },

            async postComment(postId) {
                const statusEl = document.getElementById(`c-status-${postId}`);
                statusEl.style.display = 'block';
                statusEl.innerText = "UPLOADING...";
                // ... 省略 POST 逻辑，保持原有即可，主要是样式 ...
            }
        };

        /* --- 4. 流式阅读器 (JS 动态生成 CSS 版) --- */
        const StreamReader = {
            apiBase: 'https://eva-proxy.whte97284.workers.dev/blog/post',
            postsApi: 'https://eva-proxy.whte97284.workers.dev/blog/posts',
            fullContentNodes: [],
            renderPointer: 0,
            CHUNK_SIZE: 15,
            hasMore: true,
            isFetching: false,
            lastPostDate: null,
            
            init() {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (!id) { this.fetchNextArticle(true); } 
                else { 
                    document.getElementById('stream-status').innerText = `REQ_ID:${id}`;
                    this.fetchArticleById(id); 
                }
                window.addEventListener('scroll', () => {
                    const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
                    if (scrollTop + clientHeight >= scrollHeight - 300) { this.fetchNextArticle(); }
                    this.handleScroll();
                });
            },

            async fetchArticleById(id) { await this.performFetch(`${this.apiBase}?id=${id}`, true); },
            async fetchNextArticle(isInitial=false) {
                if (this.isFetching || !this.hasMore) return;
                let url = `${this.postsApi}?_embed&per_page=1`;
                if (this.lastPostDate) url += `&before=${this.lastPostDate}`;
                document.getElementById('loading-more').classList.remove('hidden');
                await this.performFetch(url, isInitial, true);
            },

            async performFetch(url, isInitial, isList) {
                this.isFetching = true;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("Network Error");
                    const text = await res.text();
                    if (text.startsWith('<')) throw new Error("Firewall");
                    let data = JSON.parse(text);
                    if (isList) {
                        if (!data.length) {
                            this.hasMore = false;
                            document.getElementById('end-of-line').classList.remove('hidden');
                            return;
                        }
                        data = data[0];
                    }
                    this.lastPostDate = data.date;
                    this.render(data);
                } catch(e) {
                    if(isInitial) document.getElementById('initial-loader').innerHTML = `<div style="color:red; text-align:center;">CONNECTION FAILED</div>`;
                } finally {
                    this.isFetching = false;
                    if(isInitial) document.getElementById('initial-loader').style.display = 'none';
                    document.getElementById('loading-more').classList.add('hidden');
                }
            },

            render(data) {
                if (!data || !data.title || !data.content) return;
                const wrapper = document.getElementById('infinite-wrapper');
                
                const div = document.createElement('div');
                div.className = 'glass-panel';
                // 强制内联样式，不依赖类名
                div.style.marginBottom = '4rem'; 
                
                div.innerHTML = `
                    <div class="hud-corner hc-tl"></div><div class="hud-corner hc-tr"></div>
                    <div class="hud-corner hc-bl"></div><div class="hud-corner hc-br"></div>
                    
                    <header style="margin-bottom: 2.5rem; text-align: center;">
                        <div style="display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; opacity: 0.7; font-family: 'JetBrains Mono'; font-size: 10px;">
                            <span style="border: 1px solid var(--primary-color); color: var(--primary-color); padding: 2px 4px; font-weight: bold;">ARCHIVE</span>
                            <span style="color: #888;">${new Date(data.date).toISOString().split('T')[0]}</span>
                        </div>
                        <h1 style="font-family: 'Noto Serif SC', serif; font-size: 2.5rem; margin: 0; line-height: 1.2; color: var(--text-main); font-weight: 900;">${data.title.rendered}</h1>
                    </header>
                    
                    <div class="prose-eva" id="stream-container-${data.id}" style="font-size: ${currentZoom}rem;"></div>
                    
                    <div style="margin-top: 3rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 2rem;">
                        <button onclick="CommentManager.toggleComms(this, ${data.id})" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem; background: rgba(var(--secondary-color), 0.05); border: 1px solid rgba(var(--secondary-color), 0.3); color: var(--secondary-color); font-family: 'JetBrains Mono'; font-size: 12px; cursor: pointer;">
                            <i data-lucide="message-square" style="width:16px; height:16px;"></i>
                            <span>OPEN_COMMS_CHANNEL [ ID: ${data.id} ]</span>
                            <i data-lucide="chevron-down" class="comm-chevron" style="width:16px; height:16px; transition:transform 0.3s;"></i>
                        </button>
                        <div id="comms-${data.id}" style="display: none; margin-top: 1.5rem; animation: none;">
                            <div style="text-align: center; padding: 1rem; font-family: 'JetBrains Mono'; font-size: 12px; color: #888;">INITIALIZING UPLINK...</div>
                        </div>
                    </div>
                    
                    <footer style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.05); text-align: center; opacity: 0.5;">
                        <div style="font-family: 'JetBrains Mono'; font-size: 10px; letter-spacing: 0.3em;">/// E.O.F ///</div>
                    </footer>
                `;
                
                wrapper.appendChild(div);
                
                const safeContent = TacticalImager.sanitizeHtmlString(data.content.rendered);
                this.prepareStream(safeContent, data.id);
                lucide.createIcons();
            },

            prepareStream(html, id) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                this.fullContentNodes = Array.from(doc.body.children);
                this.renderPointer = 0;
                this.currentStreamContainer = document.getElementById(`stream-container-${id}`);
                document.getElementById('initial-loader').style.display = 'none';
                document.getElementById('stream-status').innerText = "STREAMING";
                
                // 立即渲染所有内容，不做分块，防止布局抖动
                this.fullContentNodes.forEach(node => {
                    const clone = document.importNode(node, true);
                    if (clone.tagName === 'IMG') {
                        clone.removeAttribute('srcset');
                        clone.setAttribute('loading', 'eager');
                        clone.style.opacity = '1';
                        if(clone.src) clone.src = TacticalImager.processUrl(clone.src);
                        clone.onclick = () => Lightbox.open(clone.src);
                    }
                    const imgs = clone.querySelectorAll('img');
                    imgs.forEach(img => {
                        img.removeAttribute('srcset');
                        img.setAttribute('loading', 'eager');
                        img.style.opacity = '1';
                        if(img.src) img.src = TacticalImager.processUrl(img.src);
                        img.onclick = () => Lightbox.open(img.src);
                    });
                    if (clone.tagName === 'PRE') hljs.highlightElement(clone.querySelector('code') || clone);
                    clone.querySelectorAll('pre code').forEach(c => hljs.highlightElement(c));
                    this.currentStreamContainer.appendChild(clone);
                });
                
                if(!this.tocGenerated) { this.updateTOC(doc); this.tocGenerated = true; }
            },

            updateTOC(doc) {
                const tocContainer = document.getElementById('toc-container');
                const headers = doc.querySelectorAll('h2, h3');
                if (headers.length > 0) {
                    tocContainer.innerHTML = '';
                    headers.forEach((header, index) => {
                        const item = document.createElement('div');
                        item.innerText = header.innerText;
                        item.style.padding = '4px 0 4px 10px';
                        item.style.borderLeft = '1px solid transparent';
                        item.style.cursor = 'pointer';
                        item.style.whiteSpace = 'nowrap';
                        item.style.overflow = 'hidden';
                        item.style.textOverflow = 'ellipsis';
                        if(header.tagName === 'H3') item.style.paddingLeft = '20px';
                        
                        item.onmouseover = () => { item.style.color = 'var(--secondary-color)'; item.style.borderLeftColor = 'var(--secondary-color)'; };
                        item.onmouseout = () => { item.style.color = 'var(--text-muted)'; item.style.borderLeftColor = 'transparent'; };
                        item.onclick = () => {
                            const realHeaders = document.querySelectorAll('h2, h3');
                            if(realHeaders[index]) realHeaders[index].scrollIntoView({behavior:'smooth', block:'start'});
                        };
                        tocContainer.appendChild(item);
                    });
                } else {
                    tocContainer.innerHTML = `<div style="text-align:center; opacity:0.3; padding:1rem;">NO INDEX DATA</div>`;
                }
            },

            handleScroll() {
                const scrollTop = window.scrollY;
                const docHeight = document.body.scrollHeight - window.innerHeight;
                const progress = (scrollTop / docHeight) * 100;
                document.getElementById('scroll-progress').style.width = `${progress}%`;
            }
        };

        let currentZoom = 1;
        function changeFontSize(dir) {
            currentZoom += dir * 0.1;
            currentZoom = Math.min(Math.max(currentZoom, 0.8), 1.4);
            document.querySelectorAll('.prose-eva').forEach(el => el.style.fontSize = `${currentZoom}rem`);
        }

        StreamReader.init();
    </script>
</body>
</html>
